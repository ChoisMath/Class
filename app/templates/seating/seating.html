{% extends "base.html" %}

{% block title %}자리배치표{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/seating.css') }}">
{% endblock %}

{% block content %}
<div class="seating-container">
    <!-- DSHS-Life 스타일 헤더 컨트롤 -->
    <div class="flex flex-wrap items-center px-2 mt-4 gap-x-5 gap-y-2">
        <div class="inline-flex shrink-0">
            <label class="text-gray-700 font-medium mr-2">날짜:</label>
            <input type="date" id="date-picker" class="py-2 px-3 text-gray-700 a-input" value="{{ today }}">
        </div>
        
        <div class="flex items-center gap-x-2">
            <select id="grade-select" class="py-2 pl-3 pr-10 text-gray-700 a-input">
                <option value="1">1학년</option>
                <option value="2">2학년</option>
                <option value="3">3학년</option>
            </select>

            <div class="flex items-center pr-10 gap-x-1">
                <button id="period-prev" class="px-2 bg-white border border-gray-300 rounded-md shadow-sm h-9 hover:bg-gray-100">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <select id="period-select" class="py-2 text-gray-700 a-input">
                    <option value="11">1차자습</option>
                    <option value="12">2차자습</option>
                    <option value="13">3차자습</option>
                    <option value="14">4차자습</option>
                    <option value="15">5차자습</option>
                    <option value="1">1교시</option>
                    <option value="2">2교시</option>
                    <option value="3">3교시</option>
                    <option value="4">4교시</option>
                    <option value="5">5교시</option>
                    <option value="6">6교시</option>
                    <option value="7">7교시</option>
                    <option value="22">중식</option>
                    <option value="23">석식</option>
                </select>
                <button id="period-next" class="px-2 bg-white border border-gray-300 rounded-md shadow-sm h-9 hover:bg-gray-100">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
            </div>
            <div id="loading-indicator" class="hidden">
                <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        </div>
    </div>
    
    <!-- DSHS-Life 스타일 자리배치표 -->
    <div class="pt-4 pb-8 mt-6 text-gray-700 bg-white border-gray-300 border-y">
        <div class="flex px-4 overflow-x-auto">
            <div id="seat-grid">
                <!-- JavaScript로 동적 생성 -->
                <div class="loading text-center text-gray-500 py-8">
                    자리배치 데이터를 불러오는 중...
                </div>
            </div>
        </div>

        <div id="bottom-left-info" class="inline-block px-2 py-3 mt-4 ml-2 text-sm font-semibold border-2 border-gray-500">
            남쪽 출입구
        </div>
    </div>
    
    <!-- DSHS-Life 스타일 부재 처리 패널 (교사만) -->
    {% if current_user.role in ['teacher', 'admin', 'super_admin'] %}
    <div class="p-4 text-gray-700 bg-white border-gray-300 border-y mt-6">
        <h3 class="text-lg font-medium text-gray-900">부재 처리</h3>

        <div class="flex items-center px-2 mt-2">
            <label class="flex items-center gap-2">
                <input type="checkbox" id="selection-mode" class="w-4 h-4 text-blue-600 border-gray-300 rounded">
                선택 모드
                <span id="selected-count" class="text-gray-600">(0명)</span>
            </label>
            <div class="flex-1"></div>
            <button id="mark-absent" class="px-3 py-1.5 text-sm text-white bg-red-600 rounded-l-md shadow-sm hover:bg-red-700 disabled:opacity-50" disabled>
                부재
            </button>
            <button id="mark-present" class="px-3 py-1.5 text-sm text-white bg-green-600 rounded-r-md shadow-sm hover:bg-green-700 disabled:opacity-50" disabled>
                복귀
            </button>
        </div>

        <ul class="mt-4 ml-6 text-gray-700 list-disc inside break-keep">
            <li>
                <b>사용법</b>
                <ol class="pl-4 list-decimal inside">
                    <li>"선택 모드" 활성화 후 자리에 없는 학생을 선택</li>
                    <li>부재 혹은 복귀 버튼 클릭</li>
                </ol>
            </li>
            <li>날짜, 학년, 교시 변경시 선택한 학생 목록이 초기화됩니다.</li>
            <li>부재 처리시 학생에게 알림이 발송됩니다.</li>
            <li>한번 더 부재 처리하거나, 부재가 아닌 학생을 복귀 처리할 경우 해당 요청은 무시됩니다.</li>
        </ul>
    </div>
    {% endif %}
</div>

<!-- 모달 창들 -->
<div id="student-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3 id="modal-title">학생 정보</h3>
        <div id="modal-body">
            <!-- 학생 상세 정보 -->
        </div>
        <div class="modal-actions">
            <button id="modal-close" class="btn btn-secondary">닫기</button>
        </div>
    </div>
</div>

<div id="notification" class="notification">
    <div class="notification-content">
        <span id="notification-message"></span>
        <button id="notification-close" class="notification-close">&times;</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/seating-manager.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        window.seatingManager = new SeatingManager({
            isTeacher: {{ 'true' if current_user.role in ['teacher', 'admin', 'super_admin'] else 'false' }},
            userId: '{{ current_user.id }}',
            userName: '{{ current_user.name }}'
        });
    });
</script>
{% endblock %}