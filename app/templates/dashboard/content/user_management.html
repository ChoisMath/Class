<!-- 통계 정보 -->
<div class="stats-grid mb-4">
    <div class="stat-card">
        <div class="stat-icon bg-primary">👥</div>
        <div class="stat-info">
            <div class="stat-number" id="totalUsers">0</div>
            <div class="stat-label">전체 사용자</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon bg-info">🎓</div>
        <div class="stat-info">
            <div class="stat-number" id="totalStudents">0</div>
            <div class="stat-label">학생</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon bg-warning">👨‍🏫</div>
        <div class="stat-info">
            <div class="stat-number" id="totalTeachers">0</div>
            <div class="stat-label">교사</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon bg-dark">👤</div>
        <div class="stat-info">
            <div class="stat-number" id="totalAdmins">0</div>
            <div class="stat-label">관리자</div>
        </div>
    </div>
</div>

<!-- 검색 및 필터 -->
<div class="search-filter-row mb-4">
    <div class="search-input">
        <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" class="form-control" id="userSearch" placeholder="이름 또는 이메일로 검색..." onkeyup="searchUsers()">
        </div>
    </div>
    <div class="filter-select">
        <select class="form-select" id="roleFilter" onchange="filterUsers()">
            <option value="">모든 역할</option>
            <option value="student">학생</option>
            <option value="teacher">교사</option>
            <option value="admin">관리자</option>
            <option value="super_admin">최고관리자</option>
        </select>
    </div>
    <div class="filter-select">
        <select class="form-select" id="statusFilter" onchange="filterUsers()">
            <option value="">모든 상태</option>
            <option value="true">활성</option>
            <option value="false">비활성</option>
        </select>
    </div>
    <div class="add-user-btn">
        <button class="btn btn-primary" onclick="openUserModal()">
            <i class="fas fa-user-plus me-2"></i>사용자 추가
        </button>
    </div>
</div>

<!-- 사용자 목록 테이블 -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>프로필</th>
                        <th>이름</th>
                        <th>이메일</th>
                        <th>역할</th>
                        <th>상태</th>
                        <th>가입일</th>
                        <th>마지막 로그인</th>
                        <th>작업</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="mt-2">사용자 목록을 불러오는 중...</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>


<!-- 사용자 편집 모달 -->
<div class="modal-overlay" id="userModal" style="display: none;">
    <div class="modal-container">
        <div class="modal-card">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalTitle">
                    <i class="fas fa-user-plus me-2"></i>새 사용자 추가
                </h5>
                <button type="button" class="modal-close-btn" onclick="closeUserModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="userForm">
                <input type="hidden" name="user_id" id="userId">
                <input type="hidden" name="mode" id="formMode" value="add">
                
                <div class="modal-content">
                    <div class="form-section">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">이메일 *</label>
                                <input type="email" class="form-input" name="email" id="userEmail" required>
                                <div class="form-help" id="emailHelpText">Google 계정 이메일을 입력하세요</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">이름 *</label>
                                <input type="text" class="form-input" name="name" id="userName" required>
                            </div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">역할 *</label>
                                <select class="form-select" name="role" id="userRole" required onchange="toggleRoleFields()">
                                    <option value="">역할을 선택하세요</option>
                                    <option value="student">학생</option>
                                    <option value="teacher">교사</option>
                                    <option value="admin">관리자</option>
                                    <option value="super_admin">최고관리자</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">상태</label>
                                <div class="form-switch">
                                    <input type="checkbox" name="is_active" id="userActive" checked>
                                    <label for="userActive">활성 상태</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 역할별 추가 정보 -->
                    <div id="studentFields" class="form-section role-fields" style="display: none;">
                        <h6 class="section-title">학생 정보</h6>
                        <div class="form-grid grid-3">
                            <div class="form-group">
                                <label class="form-label">학번</label>
                                <input type="text" class="form-input" name="student_id">
                            </div>
                            <div class="form-group">
                                <label class="form-label">학년</label>
                                <select class="form-select" name="grade">
                                    <option value="">선택</option>
                                    <option value="1">1학년</option>
                                    <option value="2">2학년</option>
                                    <option value="3">3학년</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">반</label>
                                <input type="number" class="form-input" name="class_number" min="1">
                            </div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">연락처</label>
                                <input type="tel" class="form-input" name="phone">
                            </div>
                            <div class="form-group">
                                <label class="form-label">보호자 연락처</label>
                                <input type="tel" class="form-input" name="parent_phone">
                            </div>
                        </div>
                    </div>

                    <div id="teacherFields" class="form-section role-fields" style="display: none;">
                        <h6 class="section-title">교사 정보</h6>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">직원번호</label>
                                <input type="text" class="form-input" name="employee_id">
                            </div>
                            <div class="form-group">
                                <label class="form-label">담당교과</label>
                                <input type="text" class="form-input" name="subject">
                            </div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">담당업무</label>
                                <input type="text" class="form-input" name="responsibility">
                            </div>
                            <div class="form-group">
                                <label class="form-label">직위</label>
                                <input type="text" class="form-input" name="position" value="교사">
                            </div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">소속부서</label>
                                <input type="text" class="form-input" name="department">
                            </div>
                            <div class="form-group">
                                <label class="form-label">연락처</label>
                                <input type="tel" class="form-input" name="teacher_phone">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="userCancelBtn" onclick="closeUserModal()">취소</button>
                    <button type="submit" class="btn btn-primary" id="userSubmitBtn">
                        <i class="fas fa-save me-1"></i>사용자 추가
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* ==================== 향상된 모달 시스템 ==================== */

/* 모달 오버레이 */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.modal-overlay.show {
    opacity: 1;
}

/* 모달 컨테이너 */
.modal-container {
    width: 100%;
    max-width: 800px;
    max-height: 90vh;
    position: relative;
    transform: translateY(30px);
    transition: transform 0.3s ease;
    display: flex;
    flex-direction: column;
}

.modal-overlay.show .modal-container {
    transform: translateY(0);
}

/* 모달 카드 */
.modal-card {
    background: white;
    border-radius: 16px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    display: flex;
    flex-direction: column;
    height: 100%;
    max-height: 90vh;
    position: relative;
    overflow: hidden;
}

/* 모달 헤더 */
.modal-header {
    padding: 24px 32px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    flex-shrink: 0;
}

.modal-title {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    flex: 1;
}

.modal-close-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    border-radius: 8px;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    cursor: pointer;
    transition: background 0.2s ease;
}

.modal-close-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}

/* 모달 콘텐츠 */
.modal-content {
    padding: 32px;
    overflow-y: auto;
    flex: 1;
    min-height: 0;
    max-height: calc(90vh - 140px); /* 헤더와 푸터 높이 제외 */
    
    /* 스크롤바 스타일링 */
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 #f1f5f9;
}

/* 웹킷 브라우저용 스크롤바 스타일 */
.modal-content::-webkit-scrollbar {
    width: 6px;
}

.modal-content::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 3px;
}

.modal-content::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
}

.modal-content::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

/* 모달 푸터 */
.modal-footer {
    padding: 24px 32px;
    border-top: 1px solid #e5e7eb;
    background: #f9fafb;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    flex-shrink: 0;
}

/* 폼 섹션 */
.form-section {
    margin-bottom: 32px;
}

.form-section:last-child {
    margin-bottom: 0;
}

.section-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: #374151;
    margin-bottom: 20px;
    padding-bottom: 8px;
    border-bottom: 2px solid #e5e7eb;
}

/* 폼 그리드 */
.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.form-grid.grid-3 {
    grid-template-columns: 1fr 1fr 1fr;
}

.form-grid:last-child {
    margin-bottom: 0;
}

/* 폼 그룹 */
.form-group {
    display: flex;
    flex-direction: column;
}

.form-label {
    font-weight: 500;
    color: #374151;
    margin-bottom: 8px;
    font-size: 0.875rem;
}

/* 폼 입력 필드 */
.form-input,
.form-select {
    padding: 12px 16px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.875rem;
    transition: all 0.2s ease;
    background: white;
}

.form-input:focus,
.form-select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-input:invalid {
    border-color: #ef4444;
}

/* 폼 도움말 */
.form-help {
    font-size: 0.75rem;
    color: #6b7280;
    margin-top: 4px;
}

/* 스위치 */
.form-switch {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 8px;
}

.form-switch input[type="checkbox"] {
    appearance: none;
    width: 48px;
    height: 24px;
    background: #d1d5db;
    border-radius: 12px;
    position: relative;
    cursor: pointer;
    transition: background 0.2s ease;
}

.form-switch input[type="checkbox"]:checked {
    background: #10b981;
}

.form-switch input[type="checkbox"]::before {
    content: '';
    position: absolute;
    width: 20px;
    height: 20px;
    background: white;
    border-radius: 10px;
    top: 2px;
    left: 2px;
    transition: transform 0.2s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.form-switch input[type="checkbox"]:checked::before {
    transform: translateX(24px);
}

.form-switch label {
    font-weight: 500;
    color: #374151;
    cursor: pointer;
    margin: 0;
}

/* 버튼 스타일 */
.btn {
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 500;
    font-size: 0.875rem;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.btn-secondary {
    background: #f3f4f6;
    color: #374151;
    border: 1px solid #d1d5db;
}

.btn-secondary:hover {
    background: #e5e7eb;
    transform: translateY(-1px);
}

/* 역할별 필드 */
.role-fields {
    background: #f8fafc;
    padding: 24px;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
}

/* 반응형 */
@media (max-width: 768px) {
    .modal-overlay {
        padding: 10px;
        align-items: flex-start;
        padding-top: 20px;
    }
    
    .modal-container {
        max-width: 100%;
        max-height: calc(100vh - 40px);
        height: auto;
    }
    
    .modal-card {
        max-height: calc(100vh - 40px);
    }
    
    .modal-content {
        max-height: calc(100vh - 200px); /* 모바일에서 헤더와 푸터 높이 제외 */
        padding: 20px;
    }
    
    .modal-header,
    .modal-footer {
        padding-left: 20px;
        padding-right: 20px;
    }
    
    .form-grid,
    .form-grid.grid-3 {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .modal-footer {
        flex-direction: column-reverse;
    }
    
    .btn {
        width: 100%;
        justify-content: center;
    }
}

/* ==================== 기존 통계 그리드 스타일 ==================== */

/* 통계 그리드 */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 2px 15px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    gap: 20px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border: 1px solid #e9ecef;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 25px rgba(0,0,0,0.12);
}

.stat-icon {
    font-size: 2.5rem;
    width: 70px;
    height: 70px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 15px;
    color: white;
    flex-shrink: 0;
}

.stat-info {
    flex: 1;
}

.stat-number {
    font-size: 2.2rem;
    font-weight: 700;
    color: #2d3748;
    margin: 0;
    line-height: 1;
}

.stat-label {
    font-size: 1rem;
    color: #718096;
    font-weight: 500;
    margin-top: 8px;
}

/* 검색 및 필터 행 */
.search-filter-row {
    display: grid;
    grid-template-columns: 2fr 200px 200px auto;
    gap: 15px;
    align-items: end;
    padding: 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    border: 1px solid #e9ecef;
}

.search-input {
    min-width: 0;
}

.filter-select {
    min-width: 180px;
}

.add-user-btn {
    min-width: 150px;
}

/* 반응형 */
@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .search-filter-row {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .filter-select,
    .add-user-btn {
        min-width: auto;
    }
}

/* 기타 스타일 */
.action-buttons .btn {
    margin-right: 5px;
}

.role-fields {
    border-top: 1px solid #dee2e6;
    padding-top: 15px;
}

.loading-row td {
    text-align: center;
    padding: 40px 0;
}
</style>

<script>
let allUsers = [];
let filteredUsers = [];

// AJAX로 로드될 때 즉시 초기화
loadUsers();

// 사용자 목록 로드
function loadUsers() {
    fetch('/dashboard/api/users')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('API Response:', data); // 디버깅용
            
            if (data.success) {
                allUsers = data.users || [];
                filteredUsers = [...allUsers];
                renderUserTable();
                updateStatistics();
            } else {
                showError('사용자 목록을 불러오는데 실패했습니다: ' + (data.message || '알 수 없는 오류'));
                showEmptyState();
            }
        })
        .catch(error => {
            console.error('사용자 목록 로드 오류:', error);
            showError(`사용자 목록을 불러오는 중 오류가 발생했습니다: ${error.message}`);
            showEmptyState();
        });
}

// 사용자 테이블 렌더링
function renderUserTable() {
    const tbody = document.getElementById('userTableBody');
    
    if (!filteredUsers || filteredUsers.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4 text-muted">
                    <i class="fas fa-users fa-2x mb-2"></i>
                    <div>표시할 사용자가 없습니다</div>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = filteredUsers.map(user => `
        <tr>
            <td>
                <img src="${user.profile_image || '/static/images/default-avatar.png'}" 
                     alt="${user.name}" class="rounded-circle" width="40" height="40">
            </td>
            <td><strong>${escapeHtml(user.name || 'N/A')}</strong></td>
            <td>${escapeHtml(user.email || 'N/A')}</td>
            <td>
                <span class="badge ${getRoleBadgeClass(user.role)}">
                    ${getRoleDisplayName(user.role)}
                </span>
            </td>
            <td>
                <span class="badge ${user.is_active ? 'bg-success' : 'bg-secondary'}">
                    ${user.is_active ? '활성' : '비활성'}
                </span>
            </td>
            <td>${formatDate(user.created_at)}</td>
            <td>${user.last_login ? formatDate(user.last_login) : '없음'}</td>
            <td class="action-buttons">
                <button class="btn btn-sm btn-outline-primary" onclick="editUser('${user.id}')" title="수정">
                    <i class="fas fa-edit me-1"></i>수정
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${user.id}', '${escapeHtml(user.name)}')" title="삭제">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

// 빈 상태 표시
function showEmptyState() {
    const tbody = document.getElementById('userTableBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="8" class="text-center py-4 text-muted">
                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                <div>사용자 목록을 불러올 수 없습니다</div>
                <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadUsers()">
                    <i class="fas fa-redo me-1"></i>다시 시도
                </button>
            </td>
        </tr>
    `;
}

// 통계 업데이트
function updateStatistics() {
    document.getElementById('totalUsers').textContent = allUsers.length;
    document.getElementById('totalStudents').textContent = allUsers.filter(u => u.role === 'student').length;
    document.getElementById('totalTeachers').textContent = allUsers.filter(u => u.role === 'teacher').length;
    document.getElementById('totalAdmins').textContent = allUsers.filter(u => ['admin', 'super_admin'].includes(u.role)).length;
}

// 검색 기능
function searchUsers() {
    const searchTerm = document.getElementById('userSearch').value.toLowerCase();
    filteredUsers = allUsers.filter(user => 
        (user.name && user.name.toLowerCase().includes(searchTerm)) || 
        (user.email && user.email.toLowerCase().includes(searchTerm))
    );
    applyFilters();
}

// 필터 적용
function filterUsers() {
    searchUsers(); // 검색 먼저 적용
    
    const roleFilter = document.getElementById('roleFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    
    if (roleFilter) {
        filteredUsers = filteredUsers.filter(user => user.role === roleFilter);
    }
    
    if (statusFilter !== '') {
        filteredUsers = filteredUsers.filter(user => user.is_active.toString() === statusFilter);
    }
    
    renderUserTable();
}

function applyFilters() {
    filterUsers();
}

// 사용자 모달 열기 (추가용)
function openUserModal() {
    resetUserForm();
    document.getElementById('formMode').value = 'add';
    document.getElementById('userModalTitle').innerHTML = '<i class="fas fa-user-plus me-2"></i>새 사용자 추가';
    document.getElementById('userSubmitBtn').innerHTML = '<i class="fas fa-save me-1"></i>사용자 추가';
    document.getElementById('userEmail').disabled = false;
    document.getElementById('emailHelpText').textContent = 'Google 계정 이메일을 입력하세요';
    
    showModal();
}

// 사용자 편집 모달 열기
function editUser(userId) {
    // 서버에서 상세 정보 가져오기 (프로필 정보 포함)
    fetch(`/dashboard/api/users/${userId}`)
        .then(response => response.json())
        .then(data => {
            if (!data.success || !data.user) {
                showError('사용자 정보를 불러올 수 없습니다.');
                return;
            }
            
            const user = data.user;
            
            resetUserForm();
            document.getElementById('formMode').value = 'edit';
            document.getElementById('userId').value = user.id;
            document.getElementById('userModalTitle').innerHTML = '<i class="fas fa-user-edit me-2"></i>사용자 정보 수정';
            document.getElementById('userSubmitBtn').innerHTML = '<i class="fas fa-save me-1"></i>정보 수정';
            
            // 폼에 기본 데이터 입력
            document.getElementById('userEmail').value = user.email;
            document.getElementById('userName').value = user.name;
            document.getElementById('userRole').value = user.role;
            document.getElementById('userActive').checked = user.is_active;
            
            // 수정 모드에서는 이메일 비활성화
            document.getElementById('userEmail').disabled = true;
            document.getElementById('emailHelpText').textContent = '이메일은 변경할 수 없습니다';
            
            // 역할별 필드 표시
            toggleRoleFields();
            
            // 프로필 정보 입력
            if (user.role === 'student' && user.student_profile) {
                const profile = user.student_profile;
                if (profile.student_id) document.querySelector('input[name="student_id"]').value = profile.student_id;
                if (profile.grade) document.querySelector('select[name="grade"]').value = profile.grade;
                if (profile.class_number) document.querySelector('input[name="class_number"]').value = profile.class_number;
                if (profile.phone) document.querySelector('input[name="phone"]').value = profile.phone;
                if (profile.parent_phone) document.querySelector('input[name="parent_phone"]').value = profile.parent_phone;
            } else if (user.role === 'teacher' && user.teacher_profile) {
                const profile = user.teacher_profile;
                if (profile.employee_id) document.querySelector('input[name="employee_id"]').value = profile.employee_id;
                if (profile.subject) document.querySelector('input[name="subject"]').value = profile.subject;
                if (profile.responsibility) document.querySelector('input[name="responsibility"]').value = profile.responsibility;
                if (profile.position) document.querySelector('input[name="position"]').value = profile.position;
                if (profile.department) document.querySelector('input[name="department"]').value = profile.department;
                if (profile.phone) document.querySelector('input[name="teacher_phone"]').value = profile.phone;
            }
            
            showModal();
        })
        .catch(error => {
            console.error('Error:', error);
            showError('사용자 정보를 불러오는 중 오류가 발생했습니다.');
        });
}

// 폼 리셋
function resetUserForm() {
    document.getElementById('userForm').reset();
    document.getElementById('userId').value = '';
    document.getElementById('formMode').value = 'add';
    document.getElementById('userActive').checked = true;
    
    // 모달 타이틀과 버튼 초기화
    document.getElementById('userModalTitle').innerHTML = '<i class="fas fa-user-plus me-2"></i>새 사용자 추가';
    document.getElementById('userSubmitBtn').innerHTML = '<i class="fas fa-save me-1"></i>사용자 추가';
    
    // 이메일 필드 활성화
    document.getElementById('userEmail').disabled = false;
    document.getElementById('emailHelpText').textContent = 'Google 계정 이메일을 입력하세요';
    
    // 역할별 필드 숨기기
    document.getElementById('studentFields').style.display = 'none';
    document.getElementById('teacherFields').style.display = 'none';
    
    // 역할별 필드들의 값들도 초기화
    const studentFields = document.getElementById('studentFields').querySelectorAll('input, select');
    studentFields.forEach(field => {
        if (field.type === 'checkbox') {
            field.checked = false;
        } else {
            field.value = '';
        }
    });
    
    const teacherFields = document.getElementById('teacherFields').querySelectorAll('input, select');
    teacherFields.forEach(field => {
        if (field.type === 'checkbox') {
            field.checked = false;
        } else {
            field.value = '';
        }
    });
}

// 역할별 필드 표시/숨김
function toggleRoleFields() {
    const role = document.getElementById('userRole').value;
    const studentFields = document.getElementById('studentFields');
    const teacherFields = document.getElementById('teacherFields');
    
    // 모든 필드 숨기기
    studentFields.style.display = 'none';
    teacherFields.style.display = 'none';
    
    // 선택된 역할에 따라 필드 표시
    if (role === 'student') {
        studentFields.style.display = 'block';
    } else if (role === 'teacher') {
        teacherFields.style.display = 'block';
    }
}

// 사용자 폼 제출
document.getElementById('userForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const mode = formData.get('mode');
    const userId = formData.get('user_id');
    
    const userData = {
        email: formData.get('email'),
        name: formData.get('name'),
        role: formData.get('role'),
        is_active: formData.get('is_active') === 'on'
    };
    
    // 역할별 추가 데이터 (추가 및 수정 모드 모두)
    if (userData.role === 'student') {
        const studentProfile = {
            student_id: formData.get('student_id'),
            grade: parseInt(formData.get('grade')) || null,
            class_number: parseInt(formData.get('class_number')) || null,
            phone: formData.get('phone'),
            parent_phone: formData.get('parent_phone')
        };
        
        // 빈 값 제거 (null이나 빈 문자열인 경우 제거)
        Object.keys(studentProfile).forEach(key => {
            if (studentProfile[key] === null || studentProfile[key] === '' || studentProfile[key] === undefined) {
                delete studentProfile[key];
            }
        });
        
        if (Object.keys(studentProfile).length > 0) {
            userData.student_profile = studentProfile;
        }
    } else if (userData.role === 'teacher') {
        const teacherProfile = {
            employee_id: formData.get('employee_id'),
            subject: formData.get('subject'),
            responsibility: formData.get('responsibility'),
            position: formData.get('position'),
            department: formData.get('department'),
            phone: formData.get('teacher_phone')
        };
        
        // 빈 값 제거 (null이나 빈 문자열인 경우 제거)
        Object.keys(teacherProfile).forEach(key => {
            if (teacherProfile[key] === null || teacherProfile[key] === '' || teacherProfile[key] === undefined) {
                delete teacherProfile[key];
            }
        });
        
        if (Object.keys(teacherProfile).length > 0) {
            userData.teacher_profile = teacherProfile;
        }
    }
    
    // API 호출
    const url = mode === 'add' ? '/dashboard/api/users' : `/dashboard/api/users/${userId}`;
    const method = mode === 'add' ? 'POST' : 'PUT';
    
    // 수정 모드일 때는 이메일 제거
    if (mode === 'edit') {
        delete userData.email;
    }
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(userData)
    })
    .then(response => {
        // HTTP 상태 코드 확인
        if (!response.ok) {
            return response.json().then(data => Promise.reject(data));
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            closeUserModal();
            const message = mode === 'add' ? '새 사용자가 성공적으로 추가되었습니다.' : '사용자 정보가 성공적으로 수정되었습니다.';
            showSuccess(message);
            loadUsers();
        } else {
            const action = mode === 'add' ? '추가' : '수정';
            showError(`사용자 ${action}에 실패했습니다: ${data.message}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        const action = mode === 'add' ? '추가' : '수정';
        const errorMessage = error.message || `사용자 ${action} 중 오류가 발생했습니다.`;
        showError(errorMessage);
    });
});


// 사용자 삭제
function deleteUser(userId, userName) {
    if (!confirm(`정말로 "${userName}" 사용자를 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다.`)) {
        return;
    }
    
    fetch(`/dashboard/api/users/${userId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('사용자가 성공적으로 삭제되었습니다.');
            loadUsers();
        } else {
            showError('사용자 삭제에 실패했습니다: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('사용자 삭제 중 오류가 발생했습니다.');
    });
}

// 유틸리티 함수들
function getRoleBadgeClass(role) {
    const classes = {
        'student': 'bg-info',
        'teacher': 'bg-warning text-dark',
        'admin': 'bg-primary',
        'super_admin': 'bg-dark'
    };
    return classes[role] || 'bg-secondary';
}

function getRoleDisplayName(role) {
    const names = {
        'student': '학생',
        'teacher': '교사',
        'admin': '관리자',
        'super_admin': '최고관리자'
    };
    return names[role] || role;
}

function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('ko-KR');
}

function escapeHtml(unsafe) {
    if (!unsafe) return '';
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function showSuccess(message) {
    // 임시로 alert 사용 (나중에 토스트로 교체 가능)
    alert('✅ ' + message);
}

function showError(message) {
    // 임시로 alert 사용 (나중에 토스트로 교체 가능)
    alert('❌ ' + message);
}

// 모달 표시
function showModal() {
    const modal = document.getElementById('userModal');
    modal.style.display = 'flex';
    setTimeout(() => {
        modal.classList.add('show');
    }, 10);
    
    // ESC 키로 닫기
    document.addEventListener('keydown', handleModalEscape);
}

// 모달 닫기
function closeUserModal() {
    const modal = document.getElementById('userModal');
    modal.classList.remove('show');
    setTimeout(() => {
        modal.style.display = 'none';
        resetUserForm();
    }, 300);
    
    // ESC 키 이벤트 리스너 제거
    document.removeEventListener('keydown', handleModalEscape);
}

// ESC 키 처리
function handleModalEscape(e) {
    if (e.key === 'Escape') {
        closeUserModal();
    }
}

// 모달 오버레이 클릭 시 닫기
document.addEventListener('DOMContentLoaded', function() {
    // 모달 오버레이 클릭 시 닫기
    document.getElementById('userModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeUserModal();
        }
    });
});
</script>