<!-- í†µê³„ ì •ë³´ -->
<div class="stats-grid mb-4">
    <div class="stat-card">
        <div class="stat-icon bg-primary">ğŸ‘¥</div>
        <div class="stat-info">
            <div class="stat-number" id="totalUsers">0</div>
            <div class="stat-label">ì „ì²´ ì‚¬ìš©ì</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon bg-info">ğŸ“</div>
        <div class="stat-info">
            <div class="stat-number" id="totalStudents">0</div>
            <div class="stat-label">í•™ìƒ</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon bg-warning">ğŸ‘¨â€ğŸ«</div>
        <div class="stat-info">
            <div class="stat-number" id="totalTeachers">0</div>
            <div class="stat-label">êµì‚¬</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon bg-dark">ğŸ‘¤</div>
        <div class="stat-info">
            <div class="stat-number" id="totalAdmins">0</div>
            <div class="stat-label">ê´€ë¦¬ì</div>
        </div>
    </div>
</div>

<!-- ê²€ìƒ‰ ë° í•„í„° -->
<div class="search-filter-row mb-4">
    <div class="search-input">
        <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" class="form-control" id="userSearch" placeholder="ì´ë¦„ ë˜ëŠ” ì´ë©”ì¼ë¡œ ê²€ìƒ‰..." onkeyup="searchUsers()">
        </div>
    </div>
    <div class="filter-select">
        <select class="form-select" id="roleFilter" onchange="filterUsers()">
            <option value="">ëª¨ë“  ì—­í• </option>
            <option value="student">í•™ìƒ</option>
            <option value="teacher">êµì‚¬</option>
            <option value="admin">ê´€ë¦¬ì</option>
            <option value="super_admin">ìµœê³ ê´€ë¦¬ì</option>
        </select>
    </div>
    <div class="filter-select">
        <select class="form-select" id="statusFilter" onchange="filterUsers()">
            <option value="">ëª¨ë“  ìƒíƒœ</option>
            <option value="true">í™œì„±</option>
            <option value="false">ë¹„í™œì„±</option>
        </select>
    </div>
    <div class="add-user-btn">
        <button class="btn btn-primary" onclick="openUserModal()">
            <i class="fas fa-user-plus me-2"></i>ì‚¬ìš©ì ì¶”ê°€
        </button>
    </div>
</div>

<!-- ì‚¬ìš©ì ëª©ë¡ í…Œì´ë¸” -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>í”„ë¡œí•„</th>
                        <th>ì´ë¦„</th>
                        <th>ì´ë©”ì¼</th>
                        <th>ì—­í• </th>
                        <th>ìƒíƒœ</th>
                        <th>ê°€ì…ì¼</th>
                        <th>ë§ˆì§€ë§‰ ë¡œê·¸ì¸</th>
                        <th>ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="mt-2">ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>


<!-- ì‚¬ìš©ì í¸ì§‘ ëª¨ë‹¬ -->
<div class="modal-overlay" id="userModal" style="display: none;">
    <div class="modal-container">
        <div class="modal-card">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalTitle">
                    <i class="fas fa-user-plus me-2"></i>ìƒˆ ì‚¬ìš©ì ì¶”ê°€
                </h5>
                <button type="button" class="modal-close-btn" onclick="closeUserModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="userForm">
                <input type="hidden" name="user_id" id="userId">
                <input type="hidden" name="mode" id="formMode" value="add">
                
                <div class="modal-content">
                    <div class="form-section">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">ì´ë©”ì¼ *</label>
                                <input type="email" class="form-input" name="email" id="userEmail" required>
                                <div class="form-help" id="emailHelpText">Google ê³„ì • ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ì´ë¦„ *</label>
                                <input type="text" class="form-input" name="name" id="userName" required>
                            </div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">ì—­í•  *</label>
                                <select class="form-select" name="role" id="userRole" required onchange="toggleRoleFields()">
                                    <option value="">ì—­í• ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                    <option value="student">í•™ìƒ</option>
                                    <option value="teacher">êµì‚¬</option>
                                    <option value="admin">ê´€ë¦¬ì</option>
                                    <option value="super_admin">ìµœê³ ê´€ë¦¬ì</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ìƒíƒœ</label>
                                <div class="form-switch">
                                    <input type="checkbox" name="is_active" id="userActive" checked>
                                    <label for="userActive">í™œì„± ìƒíƒœ</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì—­í• ë³„ ì¶”ê°€ ì •ë³´ -->
                    <div id="studentFields" class="form-section role-fields" style="display: none;">
                        <h6 class="section-title">í•™ìƒ ì •ë³´</h6>
                        <div class="form-grid grid-3">
                            <div class="form-group">
                                <label class="form-label">í•™ë²ˆ</label>
                                <input type="text" class="form-input" name="student_id">
                            </div>
                            <div class="form-group">
                                <label class="form-label">í•™ë…„</label>
                                <select class="form-select" name="grade">
                                    <option value="">ì„ íƒ</option>
                                    <option value="1">1í•™ë…„</option>
                                    <option value="2">2í•™ë…„</option>
                                    <option value="3">3í•™ë…„</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ë°˜</label>
                                <input type="number" class="form-input" name="class_number" min="1">
                            </div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">ì—°ë½ì²˜</label>
                                <input type="tel" class="form-input" name="phone">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ë³´í˜¸ì ì—°ë½ì²˜</label>
                                <input type="tel" class="form-input" name="parent_phone">
                            </div>
                        </div>
                    </div>

                    <div id="teacherFields" class="form-section role-fields" style="display: none;">
                        <h6 class="section-title">êµì‚¬ ì •ë³´</h6>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">ì§ì›ë²ˆí˜¸</label>
                                <input type="text" class="form-input" name="employee_id">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ë‹´ë‹¹êµê³¼</label>
                                <input type="text" class="form-input" name="subject">
                            </div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">ë‹´ë‹¹ì—…ë¬´</label>
                                <input type="text" class="form-input" name="responsibility">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ì§ìœ„</label>
                                <input type="text" class="form-input" name="position" value="êµì‚¬">
                            </div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">ì†Œì†ë¶€ì„œ</label>
                                <input type="text" class="form-input" name="department">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ì—°ë½ì²˜</label>
                                <input type="tel" class="form-input" name="teacher_phone">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="userCancelBtn" onclick="closeUserModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary" id="userSubmitBtn">
                        <i class="fas fa-save me-1"></i>ì‚¬ìš©ì ì¶”ê°€
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* ==================== í–¥ìƒëœ ëª¨ë‹¬ ì‹œìŠ¤í…œ ==================== */

/* ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.modal-overlay.show {
    opacity: 1;
}

/* ëª¨ë‹¬ ì»¨í…Œì´ë„ˆ */
.modal-container {
    width: 100%;
    max-width: 800px;
    max-height: 90vh;
    position: relative;
    transform: translateY(30px);
    transition: transform 0.3s ease;
    display: flex;
    flex-direction: column;
}

.modal-overlay.show .modal-container {
    transform: translateY(0);
}

/* ëª¨ë‹¬ ì¹´ë“œ */
.modal-card {
    background: white;
    border-radius: 16px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    display: flex;
    flex-direction: column;
    height: 100%;
    max-height: 90vh;
    position: relative;
    overflow: hidden;
}

/* ëª¨ë‹¬ í—¤ë” */
.modal-header {
    padding: 24px 32px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    flex-shrink: 0;
}

.modal-title {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    flex: 1;
}

.modal-close-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    border-radius: 8px;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    cursor: pointer;
    transition: background 0.2s ease;
}

.modal-close-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}

/* ëª¨ë‹¬ ì½˜í…ì¸  */
.modal-content {
    padding: 32px;
    overflow-y: auto;
    flex: 1;
    min-height: 0;
    max-height: calc(90vh - 140px); /* í—¤ë”ì™€ í‘¸í„° ë†’ì´ ì œì™¸ */
    
    /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ë§ */
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 #f1f5f9;
}

/* ì›¹í‚· ë¸Œë¼ìš°ì €ìš© ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
.modal-content::-webkit-scrollbar {
    width: 6px;
}

.modal-content::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 3px;
}

.modal-content::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
}

.modal-content::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

/* ëª¨ë‹¬ í‘¸í„° */
.modal-footer {
    padding: 24px 32px;
    border-top: 1px solid #e5e7eb;
    background: #f9fafb;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    flex-shrink: 0;
}

/* í¼ ì„¹ì…˜ */
.form-section {
    margin-bottom: 32px;
}

.form-section:last-child {
    margin-bottom: 0;
}

.section-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: #374151;
    margin-bottom: 20px;
    padding-bottom: 8px;
    border-bottom: 2px solid #e5e7eb;
}

/* í¼ ê·¸ë¦¬ë“œ */
.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.form-grid.grid-3 {
    grid-template-columns: 1fr 1fr 1fr;
}

.form-grid:last-child {
    margin-bottom: 0;
}

/* í¼ ê·¸ë£¹ */
.form-group {
    display: flex;
    flex-direction: column;
}

.form-label {
    font-weight: 500;
    color: #374151;
    margin-bottom: 8px;
    font-size: 0.875rem;
}

/* í¼ ì…ë ¥ í•„ë“œ */
.form-input,
.form-select {
    padding: 12px 16px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.875rem;
    transition: all 0.2s ease;
    background: white;
}

.form-input:focus,
.form-select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-input:invalid {
    border-color: #ef4444;
}

/* í¼ ë„ì›€ë§ */
.form-help {
    font-size: 0.75rem;
    color: #6b7280;
    margin-top: 4px;
}

/* ìŠ¤ìœ„ì¹˜ */
.form-switch {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 8px;
}

.form-switch input[type="checkbox"] {
    appearance: none;
    width: 48px;
    height: 24px;
    background: #d1d5db;
    border-radius: 12px;
    position: relative;
    cursor: pointer;
    transition: background 0.2s ease;
}

.form-switch input[type="checkbox"]:checked {
    background: #10b981;
}

.form-switch input[type="checkbox"]::before {
    content: '';
    position: absolute;
    width: 20px;
    height: 20px;
    background: white;
    border-radius: 10px;
    top: 2px;
    left: 2px;
    transition: transform 0.2s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.form-switch input[type="checkbox"]:checked::before {
    transform: translateX(24px);
}

.form-switch label {
    font-weight: 500;
    color: #374151;
    cursor: pointer;
    margin: 0;
}

/* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.btn {
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 500;
    font-size: 0.875rem;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.btn-secondary {
    background: #f3f4f6;
    color: #374151;
    border: 1px solid #d1d5db;
}

.btn-secondary:hover {
    background: #e5e7eb;
    transform: translateY(-1px);
}

/* ì—­í• ë³„ í•„ë“œ */
.role-fields {
    background: #f8fafc;
    padding: 24px;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
}

/* ë°˜ì‘í˜• */
@media (max-width: 768px) {
    .modal-overlay {
        padding: 10px;
        align-items: flex-start;
        padding-top: 20px;
    }
    
    .modal-container {
        max-width: 100%;
        max-height: calc(100vh - 40px);
        height: auto;
    }
    
    .modal-card {
        max-height: calc(100vh - 40px);
    }
    
    .modal-content {
        max-height: calc(100vh - 200px); /* ëª¨ë°”ì¼ì—ì„œ í—¤ë”ì™€ í‘¸í„° ë†’ì´ ì œì™¸ */
        padding: 20px;
    }
    
    .modal-header,
    .modal-footer {
        padding-left: 20px;
        padding-right: 20px;
    }
    
    .form-grid,
    .form-grid.grid-3 {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .modal-footer {
        flex-direction: column-reverse;
    }
    
    .btn {
        width: 100%;
        justify-content: center;
    }
}

/* ==================== ê¸°ì¡´ í†µê³„ ê·¸ë¦¬ë“œ ìŠ¤íƒ€ì¼ ==================== */

/* í†µê³„ ê·¸ë¦¬ë“œ */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 2px 15px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    gap: 20px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border: 1px solid #e9ecef;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 25px rgba(0,0,0,0.12);
}

.stat-icon {
    font-size: 2.5rem;
    width: 70px;
    height: 70px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 15px;
    color: white;
    flex-shrink: 0;
}

.stat-info {
    flex: 1;
}

.stat-number {
    font-size: 2.2rem;
    font-weight: 700;
    color: #2d3748;
    margin: 0;
    line-height: 1;
}

.stat-label {
    font-size: 1rem;
    color: #718096;
    font-weight: 500;
    margin-top: 8px;
}

/* ê²€ìƒ‰ ë° í•„í„° í–‰ */
.search-filter-row {
    display: grid;
    grid-template-columns: 2fr 200px 200px auto;
    gap: 15px;
    align-items: end;
    padding: 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    border: 1px solid #e9ecef;
}

.search-input {
    min-width: 0;
}

.filter-select {
    min-width: 180px;
}

.add-user-btn {
    min-width: 150px;
}

/* ë°˜ì‘í˜• */
@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .search-filter-row {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .filter-select,
    .add-user-btn {
        min-width: auto;
    }
}

/* ê¸°íƒ€ ìŠ¤íƒ€ì¼ */
.action-buttons .btn {
    margin-right: 5px;
}

.role-fields {
    border-top: 1px solid #dee2e6;
    padding-top: 15px;
}

.loading-row td {
    text-align: center;
    padding: 40px 0;
}
</style>

<script>
let allUsers = [];
let filteredUsers = [];

// AJAXë¡œ ë¡œë“œë  ë•Œ ì¦‰ì‹œ ì´ˆê¸°í™”
loadUsers();

// ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ
function loadUsers() {
    fetch('/dashboard/api/users')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('API Response:', data); // ë””ë²„ê¹…ìš©
            
            if (data.success) {
                allUsers = data.users || [];
                filteredUsers = [...allUsers];
                renderUserTable();
                updateStatistics();
            } else {
                showError('ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                showEmptyState();
            }
        })
        .catch(error => {
            console.error('ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
            showError(`ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            showEmptyState();
        });
}

// ì‚¬ìš©ì í…Œì´ë¸” ë Œë”ë§
function renderUserTable() {
    const tbody = document.getElementById('userTableBody');
    
    if (!filteredUsers || filteredUsers.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4 text-muted">
                    <i class="fas fa-users fa-2x mb-2"></i>
                    <div>í‘œì‹œí•  ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤</div>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = filteredUsers.map(user => `
        <tr>
            <td>
                <img src="${user.profile_image || '/static/images/default-avatar.png'}" 
                     alt="${user.name}" class="rounded-circle" width="40" height="40">
            </td>
            <td><strong>${escapeHtml(user.name || 'N/A')}</strong></td>
            <td>${escapeHtml(user.email || 'N/A')}</td>
            <td>
                <span class="badge ${getRoleBadgeClass(user.role)}">
                    ${getRoleDisplayName(user.role)}
                </span>
            </td>
            <td>
                <span class="badge ${user.is_active ? 'bg-success' : 'bg-secondary'}">
                    ${user.is_active ? 'í™œì„±' : 'ë¹„í™œì„±'}
                </span>
            </td>
            <td>${formatDate(user.created_at)}</td>
            <td>${user.last_login ? formatDate(user.last_login) : 'ì—†ìŒ'}</td>
            <td class="action-buttons">
                <button class="btn btn-sm btn-outline-primary" onclick="editUser('${user.id}')" title="ìˆ˜ì •">
                    <i class="fas fa-edit me-1"></i>ìˆ˜ì •
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${user.id}', '${escapeHtml(user.name)}')" title="ì‚­ì œ">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

// ë¹ˆ ìƒíƒœ í‘œì‹œ
function showEmptyState() {
    const tbody = document.getElementById('userTableBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="8" class="text-center py-4 text-muted">
                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                <div>ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadUsers()">
                    <i class="fas fa-redo me-1"></i>ë‹¤ì‹œ ì‹œë„
                </button>
            </td>
        </tr>
    `;
}

// í†µê³„ ì—…ë°ì´íŠ¸
function updateStatistics() {
    document.getElementById('totalUsers').textContent = allUsers.length;
    document.getElementById('totalStudents').textContent = allUsers.filter(u => u.role === 'student').length;
    document.getElementById('totalTeachers').textContent = allUsers.filter(u => u.role === 'teacher').length;
    document.getElementById('totalAdmins').textContent = allUsers.filter(u => ['admin', 'super_admin'].includes(u.role)).length;
}

// ê²€ìƒ‰ ê¸°ëŠ¥
function searchUsers() {
    const searchTerm = document.getElementById('userSearch').value.toLowerCase();
    filteredUsers = allUsers.filter(user => 
        (user.name && user.name.toLowerCase().includes(searchTerm)) || 
        (user.email && user.email.toLowerCase().includes(searchTerm))
    );
    applyFilters();
}

// í•„í„° ì ìš©
function filterUsers() {
    searchUsers(); // ê²€ìƒ‰ ë¨¼ì € ì ìš©
    
    const roleFilter = document.getElementById('roleFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    
    if (roleFilter) {
        filteredUsers = filteredUsers.filter(user => user.role === roleFilter);
    }
    
    if (statusFilter !== '') {
        filteredUsers = filteredUsers.filter(user => user.is_active.toString() === statusFilter);
    }
    
    renderUserTable();
}

function applyFilters() {
    filterUsers();
}

// ì‚¬ìš©ì ëª¨ë‹¬ ì—´ê¸° (ì¶”ê°€ìš©)
function openUserModal() {
    resetUserForm();
    document.getElementById('formMode').value = 'add';
    document.getElementById('userModalTitle').innerHTML = '<i class="fas fa-user-plus me-2"></i>ìƒˆ ì‚¬ìš©ì ì¶”ê°€';
    document.getElementById('userSubmitBtn').innerHTML = '<i class="fas fa-save me-1"></i>ì‚¬ìš©ì ì¶”ê°€';
    document.getElementById('userEmail').disabled = false;
    document.getElementById('emailHelpText').textContent = 'Google ê³„ì • ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”';
    
    showModal();
}

// ì‚¬ìš©ì í¸ì§‘ ëª¨ë‹¬ ì—´ê¸°
function editUser(userId) {
    // ì„œë²„ì—ì„œ ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (í”„ë¡œí•„ ì •ë³´ í¬í•¨)
    fetch(`/dashboard/api/users/${userId}`)
        .then(response => response.json())
        .then(data => {
            if (!data.success || !data.user) {
                showError('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const user = data.user;
            
            resetUserForm();
            document.getElementById('formMode').value = 'edit';
            document.getElementById('userId').value = user.id;
            document.getElementById('userModalTitle').innerHTML = '<i class="fas fa-user-edit me-2"></i>ì‚¬ìš©ì ì •ë³´ ìˆ˜ì •';
            document.getElementById('userSubmitBtn').innerHTML = '<i class="fas fa-save me-1"></i>ì •ë³´ ìˆ˜ì •';
            
            // í¼ì— ê¸°ë³¸ ë°ì´í„° ì…ë ¥
            document.getElementById('userEmail').value = user.email;
            document.getElementById('userName').value = user.name;
            document.getElementById('userRole').value = user.role;
            document.getElementById('userActive').checked = user.is_active;
            
            // ìˆ˜ì • ëª¨ë“œì—ì„œëŠ” ì´ë©”ì¼ ë¹„í™œì„±í™”
            document.getElementById('userEmail').disabled = true;
            document.getElementById('emailHelpText').textContent = 'ì´ë©”ì¼ì€ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
            
            // ì—­í• ë³„ í•„ë“œ í‘œì‹œ
            toggleRoleFields();
            
            // í”„ë¡œí•„ ì •ë³´ ì…ë ¥
            if (user.role === 'student' && user.student_profile) {
                const profile = user.student_profile;
                if (profile.student_id) document.querySelector('input[name="student_id"]').value = profile.student_id;
                if (profile.grade) document.querySelector('select[name="grade"]').value = profile.grade;
                if (profile.class_number) document.querySelector('input[name="class_number"]').value = profile.class_number;
                if (profile.phone) document.querySelector('input[name="phone"]').value = profile.phone;
                if (profile.parent_phone) document.querySelector('input[name="parent_phone"]').value = profile.parent_phone;
            } else if (user.role === 'teacher' && user.teacher_profile) {
                const profile = user.teacher_profile;
                if (profile.employee_id) document.querySelector('input[name="employee_id"]').value = profile.employee_id;
                if (profile.subject) document.querySelector('input[name="subject"]').value = profile.subject;
                if (profile.responsibility) document.querySelector('input[name="responsibility"]').value = profile.responsibility;
                if (profile.position) document.querySelector('input[name="position"]').value = profile.position;
                if (profile.department) document.querySelector('input[name="department"]').value = profile.department;
                if (profile.phone) document.querySelector('input[name="teacher_phone"]').value = profile.phone;
            }
            
            showModal();
        })
        .catch(error => {
            console.error('Error:', error);
            showError('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
}

// í¼ ë¦¬ì…‹
function resetUserForm() {
    document.getElementById('userForm').reset();
    document.getElementById('userId').value = '';
    document.getElementById('formMode').value = 'add';
    document.getElementById('userActive').checked = true;
    
    // ëª¨ë‹¬ íƒ€ì´í‹€ê³¼ ë²„íŠ¼ ì´ˆê¸°í™”
    document.getElementById('userModalTitle').innerHTML = '<i class="fas fa-user-plus me-2"></i>ìƒˆ ì‚¬ìš©ì ì¶”ê°€';
    document.getElementById('userSubmitBtn').innerHTML = '<i class="fas fa-save me-1"></i>ì‚¬ìš©ì ì¶”ê°€';
    
    // ì´ë©”ì¼ í•„ë“œ í™œì„±í™”
    document.getElementById('userEmail').disabled = false;
    document.getElementById('emailHelpText').textContent = 'Google ê³„ì • ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”';
    
    // ì—­í• ë³„ í•„ë“œ ìˆ¨ê¸°ê¸°
    document.getElementById('studentFields').style.display = 'none';
    document.getElementById('teacherFields').style.display = 'none';
    
    // ì—­í• ë³„ í•„ë“œë“¤ì˜ ê°’ë“¤ë„ ì´ˆê¸°í™”
    const studentFields = document.getElementById('studentFields').querySelectorAll('input, select');
    studentFields.forEach(field => {
        if (field.type === 'checkbox') {
            field.checked = false;
        } else {
            field.value = '';
        }
    });
    
    const teacherFields = document.getElementById('teacherFields').querySelectorAll('input, select');
    teacherFields.forEach(field => {
        if (field.type === 'checkbox') {
            field.checked = false;
        } else {
            field.value = '';
        }
    });
}

// ì—­í• ë³„ í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€
function toggleRoleFields() {
    const role = document.getElementById('userRole').value;
    const studentFields = document.getElementById('studentFields');
    const teacherFields = document.getElementById('teacherFields');
    
    // ëª¨ë“  í•„ë“œ ìˆ¨ê¸°ê¸°
    studentFields.style.display = 'none';
    teacherFields.style.display = 'none';
    
    // ì„ íƒëœ ì—­í• ì— ë”°ë¼ í•„ë“œ í‘œì‹œ
    if (role === 'student') {
        studentFields.style.display = 'block';
    } else if (role === 'teacher') {
        teacherFields.style.display = 'block';
    }
}

// ì‚¬ìš©ì í¼ ì œì¶œ
document.getElementById('userForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const mode = formData.get('mode');
    const userId = formData.get('user_id');
    
    const userData = {
        email: formData.get('email'),
        name: formData.get('name'),
        role: formData.get('role'),
        is_active: formData.get('is_active') === 'on'
    };
    
    // ì—­í• ë³„ ì¶”ê°€ ë°ì´í„° (ì¶”ê°€ ë° ìˆ˜ì • ëª¨ë“œ ëª¨ë‘)
    if (userData.role === 'student') {
        const studentProfile = {
            student_id: formData.get('student_id'),
            grade: parseInt(formData.get('grade')) || null,
            class_number: parseInt(formData.get('class_number')) || null,
            phone: formData.get('phone'),
            parent_phone: formData.get('parent_phone')
        };
        
        // ë¹ˆ ê°’ ì œê±° (nullì´ë‚˜ ë¹ˆ ë¬¸ìì—´ì¸ ê²½ìš° ì œê±°)
        Object.keys(studentProfile).forEach(key => {
            if (studentProfile[key] === null || studentProfile[key] === '' || studentProfile[key] === undefined) {
                delete studentProfile[key];
            }
        });
        
        if (Object.keys(studentProfile).length > 0) {
            userData.student_profile = studentProfile;
        }
    } else if (userData.role === 'teacher') {
        const teacherProfile = {
            employee_id: formData.get('employee_id'),
            subject: formData.get('subject'),
            responsibility: formData.get('responsibility'),
            position: formData.get('position'),
            department: formData.get('department'),
            phone: formData.get('teacher_phone')
        };
        
        // ë¹ˆ ê°’ ì œê±° (nullì´ë‚˜ ë¹ˆ ë¬¸ìì—´ì¸ ê²½ìš° ì œê±°)
        Object.keys(teacherProfile).forEach(key => {
            if (teacherProfile[key] === null || teacherProfile[key] === '' || teacherProfile[key] === undefined) {
                delete teacherProfile[key];
            }
        });
        
        if (Object.keys(teacherProfile).length > 0) {
            userData.teacher_profile = teacherProfile;
        }
    }
    
    // API í˜¸ì¶œ
    const url = mode === 'add' ? '/dashboard/api/users' : `/dashboard/api/users/${userId}`;
    const method = mode === 'add' ? 'POST' : 'PUT';
    
    // ìˆ˜ì • ëª¨ë“œì¼ ë•ŒëŠ” ì´ë©”ì¼ ì œê±°
    if (mode === 'edit') {
        delete userData.email;
    }
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(userData)
    })
    .then(response => {
        // HTTP ìƒíƒœ ì½”ë“œ í™•ì¸
        if (!response.ok) {
            return response.json().then(data => Promise.reject(data));
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            closeUserModal();
            const message = mode === 'add' ? 'ìƒˆ ì‚¬ìš©ìê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì‚¬ìš©ì ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.';
            showSuccess(message);
            loadUsers();
        } else {
            const action = mode === 'add' ? 'ì¶”ê°€' : 'ìˆ˜ì •';
            showError(`ì‚¬ìš©ì ${action}ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${data.message}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        const action = mode === 'add' ? 'ì¶”ê°€' : 'ìˆ˜ì •';
        const errorMessage = error.message || `ì‚¬ìš©ì ${action} ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`;
        showError(errorMessage);
    });
});


// ì‚¬ìš©ì ì‚­ì œ
function deleteUser(userId, userName) {
    if (!confirm(`ì •ë§ë¡œ "${userName}" ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
        return;
    }
    
    fetch(`/dashboard/api/users/${userId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('ì‚¬ìš©ìê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadUsers();
        } else {
            showError('ì‚¬ìš©ì ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('ì‚¬ìš©ì ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
function getRoleBadgeClass(role) {
    const classes = {
        'student': 'bg-info',
        'teacher': 'bg-warning text-dark',
        'admin': 'bg-primary',
        'super_admin': 'bg-dark'
    };
    return classes[role] || 'bg-secondary';
}

function getRoleDisplayName(role) {
    const names = {
        'student': 'í•™ìƒ',
        'teacher': 'êµì‚¬',
        'admin': 'ê´€ë¦¬ì',
        'super_admin': 'ìµœê³ ê´€ë¦¬ì'
    };
    return names[role] || role;
}

function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('ko-KR');
}

function escapeHtml(unsafe) {
    if (!unsafe) return '';
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function showSuccess(message) {
    // ì„ì‹œë¡œ alert ì‚¬ìš© (ë‚˜ì¤‘ì— í† ìŠ¤íŠ¸ë¡œ êµì²´ ê°€ëŠ¥)
    alert('âœ… ' + message);
}

function showError(message) {
    // ì„ì‹œë¡œ alert ì‚¬ìš© (ë‚˜ì¤‘ì— í† ìŠ¤íŠ¸ë¡œ êµì²´ ê°€ëŠ¥)
    alert('âŒ ' + message);
}

// ëª¨ë‹¬ í‘œì‹œ
function showModal() {
    const modal = document.getElementById('userModal');
    modal.style.display = 'flex';
    setTimeout(() => {
        modal.classList.add('show');
    }, 10);
    
    // ESC í‚¤ë¡œ ë‹«ê¸°
    document.addEventListener('keydown', handleModalEscape);
}

// ëª¨ë‹¬ ë‹«ê¸°
function closeUserModal() {
    const modal = document.getElementById('userModal');
    modal.classList.remove('show');
    setTimeout(() => {
        modal.style.display = 'none';
        resetUserForm();
    }, 300);
    
    // ESC í‚¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
    document.removeEventListener('keydown', handleModalEscape);
}

// ESC í‚¤ ì²˜ë¦¬
function handleModalEscape(e) {
    if (e.key === 'Escape') {
        closeUserModal();
    }
}

// ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ ë‹«ê¸°
document.addEventListener('DOMContentLoaded', function() {
    // ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ ë‹«ê¸°
    document.getElementById('userModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeUserModal();
        }
    });
});
</script>