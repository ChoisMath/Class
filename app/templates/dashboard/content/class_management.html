<div class="class-management-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4><i class="fas fa-chalkboard-teacher"></i> 학급 관리</h4>
        <div>
            <span id="userRoleInfo" class="text-muted me-3"></span>
            <button class="btn btn-primary" onclick="showStudentModal()" id="addStudentBtn">
                <i class="fas fa-user-plus"></i> 학생 추가
            </button>
        </div>
    </div>
    
    <!-- 학급 선택 (admin/super_admin용) -->
    <div class="row mb-4" id="classSelector" style="display: none;">
        <div class="col-md-6">
            <label class="form-label">학급 선택</label>
            <select class="form-select" id="classSelect" onchange="loadClassStudents()">
                <option value="">학급을 선택하세요</option>
            </select>
        </div>
    </div>
    
    <!-- 현재 선택된 학급 정보 -->
    <div class="alert alert-info" id="currentClassInfo" style="display: none;">
        <h6 class="mb-1">현재 학급</h6>
        <div id="classInfoContent"></div>
    </div>
    
    <!-- 학생 목록 -->
    <div class="card">
        <div class="card-header">
            <h6 class="mb-0">학생 목록</h6>
        </div>
        <div class="card-body">
            <!-- 검색 -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="text" class="form-control" id="studentSearch" placeholder="학생 이름 또는 이메일로 검색">
                        <button class="btn btn-outline-secondary" onclick="searchStudents()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 학생 테이블 -->
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>이름</th>
                            <th>이메일</th>
                            <th>등록일</th>
                            <th>상태</th>
                            <th>작업</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTableBody">
                        <tr>
                            <td colspan="5" class="text-center">
                                <i class="fas fa-spinner fa-spin"></i> 데이터를 불러오는 중...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 학생 추가/편집 모달 -->
<div class="modal fade" id="studentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="studentModalTitle">학생 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="studentForm">
                    <input type="hidden" name="action" id="studentAction" value="add">
                    <input type="hidden" name="current_class_id" id="currentClassId">
                    <div class="mb-3">
                        <label class="form-label">학생 이메일 *</label>
                        <input type="email" class="form-control" name="student_email" id="studentEmail" required>
                        <div class="form-text">등록된 학생 계정의 이메일을 입력하세요.</div>
                    </div>
                    <div class="mb-3" id="studentInfoDiv" style="display: none;">
                        <div class="alert alert-success">
                            <strong>학생 정보:</strong>
                            <div id="studentInfo"></div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="addStudentToClass()">추가</button>
            </div>
        </div>
    </div>
</div>

<style>
.class-management-container {
    max-width: 100%;
}

.student-row {
    transition: background-color 0.2s ease;
}

.student-row:hover {
    background-color: #f8f9fa;
}

.action-buttons .btn {
    margin-right: 5px;
    padding: 5px 10px;
}

.status-active {
    color: #28a745;
}

.status-inactive {
    color: #dc3545;
}

.class-info-item {
    margin-bottom: 5px;
}

@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.9em;
    }
    
    .action-buttons .btn {
        padding: 3px 8px;
        font-size: 0.8em;
    }
}
</style>

<script>
let currentUser = null;
let allClasses = [];
let currentClassId = null;
let classStudents = [];
let allStudents = [];

// AJAX로 로드될 때 즉시 초기화
initializeClassManagement();

function initializeClassManagement() {
    // 사용자 역할 확인 및 UI 설정
    fetch('/dashboard/api/current-user')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentUser = data.user;
                setupUIForRole();
                loadUserClasses();
            } else {
                showError('사용자 정보를 불러올 수 없습니다.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('사용자 정보 불러오기 중 오류가 발생했습니다.');
        });
}

function setupUIForRole() {
    const roleInfo = document.getElementById('userRoleInfo');
    const classSelector = document.getElementById('classSelector');
    
    if (currentUser.role === 'teacher') {
        roleInfo.textContent = '담임 학급만 관리할 수 있습니다.';
        classSelector.style.display = 'none';
    } else if (currentUser.role === 'admin' || currentUser.role === 'super_admin') {
        roleInfo.textContent = '모든 학급을 관리할 수 있습니다.';
        classSelector.style.display = 'block';
    }
}

function loadUserClasses() {
    fetch('/dashboard/api/classes')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                allClasses = data.classes;
                if (currentUser.role === 'teacher') {
                    // 교사는 첫 번째 담임 학급 자동 선택
                    if (allClasses.length > 0) {
                        currentClassId = allClasses[0].id;
                        showCurrentClassInfo(allClasses[0]);
                        loadClassStudents();
                    } else {
                        showNoClassMessage();
                    }
                } else {
                    // 관리자는 학급 선택 옵션 표시
                    populateClassSelector();
                }
            } else {
                showError('학급 정보를 불러오는데 실패했습니다: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('학급 정보를 불러오는 중 오류가 발생했습니다.');
        });
}

function populateClassSelector() {
    const select = document.getElementById('classSelect');
    select.innerHTML = '<option value="">학급을 선택하세요</option>';
    
    allClasses.forEach(cls => {
        const schoolName = cls.schools ? cls.schools.name : '알 수 없음';
        const option = document.createElement('option');
        option.value = cls.id;
        option.textContent = `${schoolName} - ${cls.grade}학년 ${cls.class_number}반`;
        select.appendChild(option);
    });
}

function loadClassStudents() {
    if (!currentClassId) {
        showNoClassSelected();
        return;
    }
    
    document.getElementById('currentClassId').value = currentClassId;
    
    fetch(`/dashboard/api/class-students/${currentClassId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                classStudents = data.students;
                renderStudentsTable();
            } else {
                showError('학생 목록을 불러오는데 실패했습니다: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('학생 목록을 불러오는 중 오류가 발생했습니다.');
        });
}

function showCurrentClassInfo(classInfo) {
    const infoDiv = document.getElementById('currentClassInfo');
    const contentDiv = document.getElementById('classInfoContent');
    
    const schoolName = classInfo.schools ? classInfo.schools.name : '알 수 없음';
    contentDiv.innerHTML = `
        <div class="class-info-item"><strong>학교:</strong> ${schoolName}</div>
        <div class="class-info-item"><strong>학급:</strong> ${classInfo.grade}학년 ${classInfo.class_number}반</div>
        <div class="class-info-item"><strong>교실:</strong> ${classInfo.room_number || '미지정'}</div>
        <div class="class-info-item"><strong>담임교사:</strong> ${classInfo.teacher_email || '미지정'}</div>
    `;
    
    infoDiv.style.display = 'block';
}

function showNoClassMessage() {
    const tbody = document.getElementById('studentsTableBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="5" class="text-center text-muted">
                담임으로 지정된 학급이 없습니다.<br>
                관리자에게 문의하세요.
            </td>
        </tr>
    `;
}

function showNoClassSelected() {
    const tbody = document.getElementById('studentsTableBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="5" class="text-center text-muted">
                학급을 선택하세요.
            </td>
        </tr>
    `;
}

function renderStudentsTable() {
    const tbody = document.getElementById('studentsTableBody');
    
    if (classStudents.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted">
                    등록된 학생이 없습니다.
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = classStudents.map(student => `
        <tr class="student-row">
            <td>${student.users ? student.users.name : '알 수 없음'}</td>
            <td>${student.student_email}</td>
            <td>${formatDate(student.enrollment_date)}</td>
            <td>
                <span class="status-${student.is_active ? 'active' : 'inactive'}">
                    <i class="fas fa-circle"></i> ${student.is_active ? '활성' : '비활성'}
                </span>
            </td>
            <td class="action-buttons">
                <button class="btn btn-sm btn-outline-danger" 
                        onclick="removeStudentFromClass('${student.student_email}', '${student.users ? student.users.name : student.student_email}')">
                    <i class="fas fa-user-minus"></i> 제거
                </button>
            </td>
        </tr>
    `).join('');
}

function showStudentModal() {
    if (!currentClassId) {
        showError('먼저 학급을 선택하세요.');
        return;
    }
    
    document.getElementById('studentForm').reset();
    document.getElementById('studentAction').value = 'add';
    document.getElementById('studentModalTitle').textContent = '학생 추가';
    document.getElementById('studentInfoDiv').style.display = 'none';
    
    new bootstrap.Modal(document.getElementById('studentModal')).show();
}

function addStudentToClass() {
    const form = document.getElementById('studentForm');
    const formData = new FormData(form);
    
    const studentEmail = formData.get('student_email');
    const classId = formData.get('current_class_id');
    
    if (!studentEmail || !classId) {
        showError('필수 정보가 누락되었습니다.');
        return;
    }
    
    const requestData = {
        student_email: studentEmail,
        class_id: classId
    };
    
    fetch('/dashboard/api/enroll-student', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('studentModal')).hide();
            showSuccess('학생이 성공적으로 학급에 추가되었습니다.');
            loadClassStudents();
        } else {
            showError('학생 추가에 실패했습니다: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('학생 추가 중 오류가 발생했습니다.');
    });
}

function removeStudentFromClass(studentEmail, studentName) {
    if (!confirm(`정말로 "${studentName}" 학생을 이 학급에서 제거하시겠습니까?`)) {
        return;
    }
    
    const requestData = {
        student_email: studentEmail,
        class_id: currentClassId
    };
    
    fetch('/dashboard/api/remove-student', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('학생이 성공적으로 학급에서 제거되었습니다.');
            loadClassStudents();
        } else {
            showError('학생 제거에 실패했습니다: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('학생 제거 중 오류가 발생했습니다.');
    });
}

function searchStudents() {
    const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
    
    if (!searchTerm) {
        renderStudentsTable();
        return;
    }
    
    const filteredStudents = classStudents.filter(student => {
        const name = student.users ? student.users.name.toLowerCase() : '';
        const email = student.student_email.toLowerCase();
        return name.includes(searchTerm) || email.includes(searchTerm);
    });
    
    const tbody = document.getElementById('studentsTableBody');
    
    if (filteredStudents.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted">
                    검색 결과가 없습니다.
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = filteredStudents.map(student => `
        <tr class="student-row">
            <td>${student.users ? student.users.name : '알 수 없음'}</td>
            <td>${student.student_email}</td>
            <td>${formatDate(student.enrollment_date)}</td>
            <td>
                <span class="status-${student.is_active ? 'active' : 'inactive'}">
                    <i class="fas fa-circle"></i> ${student.is_active ? '활성' : '비활성'}
                </span>
            </td>
            <td class="action-buttons">
                <button class="btn btn-sm btn-outline-danger" 
                        onclick="removeStudentFromClass('${student.student_email}', '${student.users ? student.users.name : student.student_email}')">
                    <i class="fas fa-user-minus"></i> 제거
                </button>
            </td>
        </tr>
    `).join('');
}

// 학급 선택 변경 시 (관리자용)
window.loadClassStudents = function() {
    const select = document.getElementById('classSelect');
    const selectedClassId = select.value;
    
    if (!selectedClassId) {
        currentClassId = null;
        document.getElementById('currentClassInfo').style.display = 'none';
        showNoClassSelected();
        return;
    }
    
    currentClassId = selectedClassId;
    const selectedClass = allClasses.find(c => c.id === selectedClassId);
    
    if (selectedClass) {
        showCurrentClassInfo(selectedClass);
        loadClassStudents();
    }
};

function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('ko-KR');
}

function showSuccess(message) {
    alert('성공: ' + message);
}

function showError(message) {
    alert('오류: ' + message);
}
</script>