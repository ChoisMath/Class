<div class="attendance-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4><i class="fas fa-calendar-check"></i> 출석체크</h4>
        <div>
            <span id="userRoleInfo" class="text-muted me-3"></span>
            <button class="btn btn-success" onclick="markTodayAttendance()" id="markAttendanceBtn" style="display: none;">
                <i class="fas fa-check"></i> 오늘 출석체크
            </button>
        </div>
    </div>
    
    <!-- 학급 선택 (교사/관리자용) -->
    <div class="row mb-4" id="classSelector" style="display: none;">
        <div class="col-md-4">
            <label class="form-label">학급 선택</label>
            <select class="form-select" id="classSelect" onchange="loadAttendanceData()">
                <option value="">학급을 선택하세요</option>
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label">날짜</label>
            <input type="date" class="form-control" id="attendanceDate" onchange="loadAttendanceData()">
        </div>
    </div>
    
    <!-- 현재 선택된 정보 -->
    <div class="alert alert-info" id="currentInfo" style="display: none;">
        <div id="infoContent"></div>
    </div>
    
    <!-- 학생용 출석 현황 -->
    <div class="card" id="studentAttendanceCard" style="display: none;">
        <div class="card-header">
            <h6 class="mb-0">내 출석 현황</h6>
        </div>
        <div class="card-body">
            <!-- 오늘 출석 상태 -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="fas fa-calendar-day fa-2x text-primary"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">오늘 출석</h6>
                            <div id="todayAttendanceStatus" class="h5 mb-0">
                                <span class="badge bg-secondary">미체크</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="fas fa-chart-line fa-2x text-success"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">이번 달 출석률</h6>
                            <div id="monthlyAttendanceRate" class="h5 mb-0 text-success">
                                계산 중...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 교시별 출석체크 버튼 -->
            <div id="periodButtons" class="mb-4">
                <h6>교시별 출석체크</h6>
                <div class="row">
                    <!-- 동적으로 생성됩니다 -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- 교사/관리자용 출석 관리 -->
    <div class="card" id="teacherAttendanceCard" style="display: none;">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">학급 출석 관리</h6>
                <button class="btn btn-sm btn-primary" onclick="showBulkAttendanceModal()">
                    <i class="fas fa-list-check"></i> 일괄 출석체크
                </button>
            </div>
        </div>
        <div class="card-body">
            <!-- 교시 선택 -->
            <div class="row mb-3">
                <div class="col-md-3">
                    <label class="form-label">교시</label>
                    <select class="form-select" id="periodSelect" onchange="loadPeriodAttendance()">
                        <option value="">교시 선택</option>
                        <option value="1">1교시</option>
                        <option value="2">2교시</option>
                        <option value="3">3교시</option>
                        <option value="4">4교시</option>
                        <option value="5">5교시</option>
                        <option value="6">6교시</option>
                        <option value="7">7교시</option>
                    </select>
                </div>
            </div>
            
            <!-- 학생별 출석 현황 -->
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>학생명</th>
                            <th>이메일</th>
                            <th>출석상태</th>
                            <th>비고</th>
                            <th>작업</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceTableBody">
                        <tr>
                            <td colspan="5" class="text-center text-muted">
                                학급과 날짜, 교시를 선택하세요.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- 출석 통계 카드 -->
    <div class="row mt-4" id="statsCards" style="display: none;">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                    <h5 id="presentCount">0</h5>
                    <small class="text-muted">출석</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                    <h5 id="lateCount">0</h5>
                    <small class="text-muted">지각</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-times-circle fa-2x text-danger mb-2"></i>
                    <h5 id="absentCount">0</h5>
                    <small class="text-muted">결석</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-user-check fa-2x text-info mb-2"></i>
                    <h5 id="excusedCount">0</h5>
                    <small class="text-muted">공결</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 개별 출석 수정 모달 -->
<div class="modal fade" id="editAttendanceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">출석 상태 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editAttendanceForm">
                    <input type="hidden" name="student_email">
                    <input type="hidden" name="class_id">
                    <input type="hidden" name="attendance_date">
                    <input type="hidden" name="period">
                    
                    <div class="mb-3">
                        <label class="form-label">학생</label>
                        <input type="text" class="form-control" name="student_name" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">출석 상태 *</label>
                        <select class="form-select" name="status" required>
                            <option value="출석">출석</option>
                            <option value="지각">지각</option>
                            <option value="조퇴">조퇴</option>
                            <option value="결석">결석</option>
                            <option value="공결">공결</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">비고</label>
                        <textarea class="form-control" name="note" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="updateAttendance()">수정</button>
            </div>
        </div>
    </div>
</div>

<!-- 일괄 출석체크 모달 -->
<div class="modal fade" id="bulkAttendanceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">일괄 출석체크</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">기본 출석 상태</label>
                    <select class="form-select" id="bulkStatus">
                        <option value="출석">모두 출석</option>
                        <option value="결석">모두 결석</option>
                    </select>
                </div>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    선택한 날짜와 교시의 모든 학생에 대해 출석 상태를 일괄 적용합니다.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="applyBulkAttendance()">적용</button>
            </div>
        </div>
    </div>
</div>

<style>
.attendance-container {
    max-width: 100%;
}

.period-btn {
    margin: 5px;
    min-width: 80px;
}

.period-btn.checked {
    background-color: #28a745;
    border-color: #28a745;
}

.attendance-status {
    font-weight: bold;
}

.status-출석 { color: #28a745; }
.status-지각 { color: #ffc107; }
.status-조퇴 { color: #fd7e14; }
.status-결석 { color: #dc3545; }
.status-공결 { color: #17a2b8; }

.stats-card {
    text-align: center;
    padding: 20px;
}

@media (max-width: 768px) {
    .period-btn {
        min-width: 60px;
        font-size: 0.9em;
    }
    
    .table-responsive {
        font-size: 0.9em;
    }
}
</style>

<script>
let currentUser = null;
let currentClassId = null;
let currentDate = null;
let currentPeriod = null;
let allClasses = [];
let classStudents = [];

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
    initializeAttendance();
});

function initializeAttendance() {
    // 오늘 날짜 설정
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('attendanceDate').value = today;
    currentDate = today;
    
    // 사용자 정보 가져오기
    fetch('/dashboard/api/current-user')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentUser = data.user;
                setupUIForRole();
                loadUserData();
            } else {
                showError('사용자 정보를 불러올 수 없습니다.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('사용자 정보 불러오기 중 오류가 발생했습니다.');
        });
}

function setupUIForRole() {
    const roleInfo = document.getElementById('userRoleInfo');
    const classSelector = document.getElementById('classSelector');
    const studentCard = document.getElementById('studentAttendanceCard');
    const teacherCard = document.getElementById('teacherAttendanceCard');
    const markBtn = document.getElementById('markAttendanceBtn');
    
    if (currentUser.role === 'student') {
        roleInfo.textContent = '자신의 출석을 체크할 수 있습니다.';
        classSelector.style.display = 'none';
        studentCard.style.display = 'block';
        teacherCard.style.display = 'none';
        markBtn.style.display = 'inline-block';
        
        generatePeriodButtons();
        loadStudentAttendance();
    } else {
        roleInfo.textContent = '학급의 출석을 관리할 수 있습니다.';
        classSelector.style.display = 'block';
        studentCard.style.display = 'none';
        teacherCard.style.display = 'block';
        markBtn.style.display = 'none';
    }
}

function loadUserData() {
    if (currentUser.role === 'student') {
        loadStudentClasses();
    } else {
        loadTeacherClasses();
    }
}

function loadStudentClasses() {
    // 학생은 자신이 속한 학급 정보를 가져옴
    fetch('/dashboard/api/student-classes')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.classes.length > 0) {
                currentClassId = data.classes[0].id;
                showCurrentInfo(`${data.classes[0].class_name} (${data.classes[0].schools.name})`);
                loadStudentAttendance();
            } else {
                showError('소속 학급을 찾을 수 없습니다.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('학급 정보를 불러오는 중 오류가 발생했습니다.');
        });
}

function loadTeacherClasses() {
    fetch('/dashboard/api/classes')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                allClasses = data.classes;
                populateClassSelector();
            } else {
                showError('학급 정보를 불러오는데 실패했습니다: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('학급 정보를 불러오는 중 오류가 발생했습니다.');
        });
}

function populateClassSelector() {
    const select = document.getElementById('classSelect');
    select.innerHTML = '<option value="">학급을 선택하세요</option>';
    
    allClasses.forEach(cls => {
        const schoolName = cls.schools ? cls.schools.name : '알 수 없음';
        const option = document.createElement('option');
        option.value = cls.id;
        option.textContent = `${schoolName} - ${cls.grade}학년 ${cls.class_number}반`;
        select.appendChild(option);
    });
}

function generatePeriodButtons() {
    const container = document.querySelector('#periodButtons .row');
    container.innerHTML = '';
    
    for (let i = 1; i <= 7; i++) {
        const col = document.createElement('div');
        col.className = 'col-6 col-md-4 col-lg-3 mb-2';
        
        const button = document.createElement('button');
        button.className = 'btn btn-outline-primary period-btn w-100';
        button.textContent = `${i}교시`;
        button.onclick = () => markPeriodAttendance(i);
        
        col.appendChild(button);
        container.appendChild(col);
    }
}

function loadStudentAttendance() {
    if (!currentClassId) return;
    
    // 오늘 출석 현황 로드
    const today = new Date().toISOString().split('T')[0];
    
    fetch(`/dashboard/api/attendance?class_id=${currentClassId}&date=${today}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateStudentAttendanceStatus(data.attendance);
            } else {
                console.error('출석 데이터 로드 실패:', data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

function updateStudentAttendanceStatus(attendanceData) {
    const myAttendance = attendanceData.filter(record => 
        record.student_email === currentUser.email
    );
    
    // 오늘 출석 상태 업데이트
    const todayStatus = document.getElementById('todayAttendanceStatus');
    const checkedPeriods = myAttendance.map(record => record.period);
    
    if (checkedPeriods.length > 0) {
        todayStatus.innerHTML = `<span class="badge bg-success">${checkedPeriods.length}교시 체크완료</span>`;
    } else {
        todayStatus.innerHTML = `<span class="badge bg-secondary">미체크</span>`;
    }
    
    // 교시별 버튼 상태 업데이트
    document.querySelectorAll('.period-btn').forEach((btn, index) => {
        const period = index + 1;
        if (checkedPeriods.includes(period)) {
            btn.classList.remove('btn-outline-primary');
            btn.classList.add('btn-success', 'checked');
            btn.innerHTML = `${period}교시 ✓`;
        } else {
            btn.classList.remove('btn-success', 'checked');
            btn.classList.add('btn-outline-primary');
            btn.innerHTML = `${period}교시`;
        }
    });
}

function markPeriodAttendance(period) {
    if (!currentClassId) {
        showError('학급 정보가 없습니다.');
        return;
    }
    
    const attendanceData = {
        student_email: currentUser.email,
        class_id: currentClassId,
        attendance_date: new Date().toISOString().split('T')[0],
        period: period,
        status: '출석'
    };
    
    fetch('/dashboard/api/attendance', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(attendanceData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(`${period}교시 출석이 완료되었습니다.`);
            loadStudentAttendance(); // 상태 새로고침
        } else {
            showError(`출석 체크에 실패했습니다: ${data.message}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('출석 체크 중 오류가 발생했습니다.');
    });
}

function markTodayAttendance() {
    // 1교시부터 7교시까지 일괄 출석 체크
    const promises = [];
    const today = new Date().toISOString().split('T')[0];
    
    for (let period = 1; period <= 7; period++) {
        const attendanceData = {
            student_email: currentUser.email,
            class_id: currentClassId,
            attendance_date: today,
            period: period,
            status: '출석'
        };
        
        promises.push(
            fetch('/dashboard/api/attendance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(attendanceData)
            })
        );
    }
    
    Promise.all(promises)
        .then(responses => Promise.all(responses.map(r => r.json())))
        .then(results => {
            const successCount = results.filter(r => r.success).length;
            showSuccess(`${successCount}교시 출석이 완료되었습니다.`);
            loadStudentAttendance();
        })
        .catch(error => {
            console.error('Error:', error);
            showError('일괄 출석 체크 중 오류가 발생했습니다.');
        });
}

function loadAttendanceData() {
    const select = document.getElementById('classSelect');
    const dateInput = document.getElementById('attendanceDate');
    
    currentClassId = select.value;
    currentDate = dateInput.value;
    
    if (!currentClassId || !currentDate) {
        document.getElementById('currentInfo').style.display = 'none';
        document.getElementById('statsCards').style.display = 'none';
        return;
    }
    
    const selectedClass = allClasses.find(c => c.id === currentClassId);
    if (selectedClass) {
        const schoolName = selectedClass.schools ? selectedClass.schools.name : '알 수 없음';
        showCurrentInfo(`${schoolName} - ${selectedClass.grade}학년 ${selectedClass.class_number}반 (${currentDate})`);
    }
    
    loadPeriodAttendance();
}

function loadPeriodAttendance() {
    const periodSelect = document.getElementById('periodSelect');
    currentPeriod = periodSelect.value;
    
    if (!currentClassId || !currentDate || !currentPeriod) {
        clearAttendanceTable();
        return;
    }
    
    // 학급 학생 목록과 해당 교시 출석 데이터 동시 로드
    Promise.all([
        fetch(`/dashboard/api/class-students/${currentClassId}`),
        fetch(`/dashboard/api/attendance?class_id=${currentClassId}&date=${currentDate}&period=${currentPeriod}`)
    ])
    .then(responses => Promise.all(responses.map(r => r.json())))
    .then(([studentsData, attendanceData]) => {
        if (studentsData.success && attendanceData.success) {
            classStudents = studentsData.students;
            renderAttendanceTable(attendanceData.attendance);
            updateStatsCards(attendanceData.attendance);
        } else {
            showError('데이터 로드에 실패했습니다.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('데이터 로드 중 오류가 발생했습니다.');
    });
}

function renderAttendanceTable(attendanceRecords) {
    const tbody = document.getElementById('attendanceTableBody');
    
    if (classStudents.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted">
                    등록된 학생이 없습니다.
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = classStudents.map(student => {
        const attendance = attendanceRecords.find(record => 
            record.student_email === student.student_email
        );
        
        const status = attendance ? attendance.status : '미체크';
        const note = attendance ? attendance.note : '';
        const studentName = student.users ? student.users.name : '알 수 없음';
        
        return `
            <tr>
                <td>${studentName}</td>
                <td>${student.student_email}</td>
                <td>
                    <span class="attendance-status status-${status}">${status}</span>
                </td>
                <td>${note}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" 
                            onclick="editStudentAttendance('${student.student_email}', '${studentName}', '${status}', '${note}')">
                        <i class="fas fa-edit"></i> 수정
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function clearAttendanceTable() {
    const tbody = document.getElementById('attendanceTableBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="5" class="text-center text-muted">
                학급과 날짜, 교시를 선택하세요.
            </td>
        </tr>
    `;
    document.getElementById('statsCards').style.display = 'none';
}

function updateStatsCards(attendanceRecords) {
    const stats = {
        출석: 0, 지각: 0, 조퇴: 0, 결석: 0, 공결: 0
    };
    
    attendanceRecords.forEach(record => {
        if (stats.hasOwnProperty(record.status)) {
            stats[record.status]++;
        }
    });
    
    document.getElementById('presentCount').textContent = stats.출석;
    document.getElementById('lateCount').textContent = stats.지각;
    document.getElementById('absentCount').textContent = stats.결석;
    document.getElementById('excusedCount').textContent = stats.공결;
    
    document.getElementById('statsCards').style.display = 'flex';
}

function editStudentAttendance(studentEmail, studentName, currentStatus, currentNote) {
    const form = document.getElementById('editAttendanceForm');
    
    form.student_email.value = studentEmail;
    form.student_name.value = studentName;
    form.class_id.value = currentClassId;
    form.attendance_date.value = currentDate;
    form.period.value = currentPeriod;
    form.status.value = currentStatus === '미체크' ? '출석' : currentStatus;
    form.note.value = currentNote;
    
    new bootstrap.Modal(document.getElementById('editAttendanceModal')).show();
}

function updateAttendance() {
    const form = document.getElementById('editAttendanceForm');
    const formData = new FormData(form);
    
    const attendanceData = {
        student_email: formData.get('student_email'),
        class_id: formData.get('class_id'),
        attendance_date: formData.get('attendance_date'),
        period: parseInt(formData.get('period')),
        status: formData.get('status'),
        note: formData.get('note')
    };
    
    fetch('/dashboard/api/attendance', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(attendanceData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('editAttendanceModal')).hide();
            showSuccess('출석 상태가 성공적으로 수정되었습니다.');
            loadPeriodAttendance();
        } else {
            showError('출석 상태 수정에 실패했습니다: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('출석 상태 수정 중 오류가 발생했습니다.');
    });
}

function showBulkAttendanceModal() {
    if (!currentClassId || !currentDate || !currentPeriod) {
        showError('학급, 날짜, 교시를 모두 선택하세요.');
        return;
    }
    
    new bootstrap.Modal(document.getElementById('bulkAttendanceModal')).show();
}

function applyBulkAttendance() {
    const status = document.getElementById('bulkStatus').value;
    const promises = [];
    
    classStudents.forEach(student => {
        const attendanceData = {
            student_email: student.student_email,
            class_id: currentClassId,
            attendance_date: currentDate,
            period: parseInt(currentPeriod),
            status: status
        };
        
        promises.push(
            fetch('/dashboard/api/attendance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(attendanceData)
            })
        );
    });
    
    Promise.all(promises)
        .then(responses => Promise.all(responses.map(r => r.json())))
        .then(results => {
            const successCount = results.filter(r => r.success).length;
            bootstrap.Modal.getInstance(document.getElementById('bulkAttendanceModal')).hide();
            showSuccess(`${successCount}명의 출석이 일괄 처리되었습니다.`);
            loadPeriodAttendance();
        })
        .catch(error => {
            console.error('Error:', error);
            showError('일괄 출석 처리 중 오류가 발생했습니다.');
        });
}

function showCurrentInfo(text) {
    document.getElementById('infoContent').innerHTML = `<strong>현재 선택:</strong> ${text}`;
    document.getElementById('currentInfo').style.display = 'block';
}

function showSuccess(message) {
    alert('성공: ' + message);
}

function showError(message) {
    alert('오류: ' + message);
}
</script>