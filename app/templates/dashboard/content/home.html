<!-- ì‹œìŠ¤í…œí˜„í™© ì½˜í…ì¸  -->
<div class="stats-grid-enhanced">
    <div class="stat-card-large">
        <div class="stat-icon">ğŸ‘¥</div>
        <div class="stat-info">
            <div class="stat-number" id="totalUsers">-</div>
            <div class="stat-label">ì „ì²´ ì‚¬ìš©ì</div>
        </div>
    </div>
    <div class="stat-card-large">
        <div class="stat-icon">ğŸ“</div>
        <div class="stat-info">
            <div class="stat-number" id="totalStudents">-</div>
            <div class="stat-label">í•™ìƒ</div>
        </div>
    </div>
    <div class="stat-card-large">
        <div class="stat-icon">ğŸ‘¨â€ğŸ«</div>
        <div class="stat-info">
            <div class="stat-number" id="totalTeachers">-</div>
            <div class="stat-label">êµì‚¬</div>
        </div>
    </div>
    <div class="stat-card-large">
        <div class="stat-icon">ğŸ“ˆ</div>
        <div class="stat-info">
            <div class="stat-number" id="utilizationRate">-</div>
            <div class="stat-label">ì´ìš©ë¥ </div>
        </div>
    </div>
</div>

<script>
// AJAX ì¬ë¡œë“œ ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë³µ ë°©ì§€
(function() {
    'use strict';
    
    // ì¬ì‹œë„ ë¡œì§ì´ ìˆëŠ” ì•ˆì „í•œ API í˜¸ì¶œ í•¨ìˆ˜
    function safeApiCall(url, options = {}, retries = 3, delay = 1000) {
    return new Promise((resolve, reject) => {
        const attemptCall = (attempt) => {
            console.log(`API í˜¸ì¶œ ì‹œë„ ${attempt}/${retries}: ${url}`);
            
            fetch(url, {
                ...options,
                timeout: 10000 // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(`API í˜¸ì¶œ ì„±ê³µ (ì‹œë„ ${attempt}):`, data);
                resolve(data);
            })
            .catch(error => {
                console.error(`API í˜¸ì¶œ ì‹¤íŒ¨ (ì‹œë„ ${attempt}):`, error);
                
                if (attempt < retries) {
                    const nextDelay = delay * Math.pow(1.5, attempt - 1); // ì§€ìˆ˜ì  ë°±ì˜¤í”„
                    console.log(`${nextDelay}ms í›„ ì¬ì‹œë„...`);
                    setTimeout(() => attemptCall(attempt + 1), nextDelay);
                } else {
                    reject(error);
                }
            });
        };
        
        attemptCall(1);
    });
}

// ë™ì  í†µê³„ ë°ì´í„° ë¡œë“œ
(function() {
    // DOMì´ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°
    function waitForDOM() {
        const elements = {
            totalUsers: document.getElementById('totalUsers'),
            totalStudents: document.getElementById('totalStudents'),
            totalTeachers: document.getElementById('totalTeachers'),
            utilizationRate: document.getElementById('utilizationRate')
        };
        
        // ëª¨ë“  ìš”ì†Œê°€ ì¤€ë¹„ë˜ì—ˆëŠ”ì§€ í™•ì¸
        if (elements.totalUsers && elements.totalStudents && elements.totalTeachers && elements.utilizationRate) {
            loadAndDisplayStats(elements);
        } else {
            setTimeout(waitForDOM, 50);
        }
    }
    
    // í†µê³„ ë°ì´í„° ë¡œë“œ ë° í‘œì‹œ (ì¬ì‹œë„ ë¡œì§ ì ìš©)
    function loadAndDisplayStats(elements) {
        safeApiCall('/dashboard/api/stats', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin'
        })
        .then(data => {
            if (data.success && data.stats) {
                // ì‹¤ì œ API ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸
                elements.totalUsers.textContent = data.stats.total_users || 0;
                elements.totalStudents.textContent = data.stats.total_students || 0;
                elements.totalTeachers.textContent = data.stats.total_teachers || 0;
                
                // ì´ìš©ë¥  ê³„ì‚° (í•™ìƒìˆ˜ ê¸°ì¤€)
                const utilizationRate = data.stats.total_students && data.stats.total_users 
                    ? Math.round((data.stats.total_students / data.stats.total_users) * 100)
                    : 0;
                elements.utilizationRate.textContent = utilizationRate + '%';
            } else {
                // API ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’
                elements.totalUsers.textContent = '0';
                elements.totalStudents.textContent = '0';
                elements.totalTeachers.textContent = '0';
                elements.utilizationRate.textContent = '0%';
            }
        })
        .catch(error => {
            // ì—°ê²° ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ ë° ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
            console.error('ì‹œìŠ¤í…œ í†µê³„ ë°ì´í„° ë¡œë“œ ìµœì¢… ì‹¤íŒ¨:', error);
            elements.totalUsers.textContent = 'ì˜¤ë¥˜';
            elements.totalStudents.textContent = 'ì˜¤ë¥˜';
            elements.totalTeachers.textContent = 'ì˜¤ë¥˜';
            elements.utilizationRate.textContent = 'ì˜¤ë¥˜';
            
            // ì½˜ì†”ì— ìƒì„¸ ì˜¤ë¥˜ ë¡œê·¸
            console.log('ì‹œìŠ¤í…œ í†µê³„ API ì—°ê²°ì— ì‹¤íŒ¨í•˜ì—¬ ê¸°ë³¸ê°’ì„ í‘œì‹œí•©ë‹ˆë‹¤.');
        });
    }
    
    // DOM í™•ì¸ ì‹œì‘
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDOM);
    } else {
        waitForDOM();
    }
    
})(); // ì¦‰ì‹œ ì‹¤í–‰ í•¨ìˆ˜ ë
})(); // ì „ì²´ ìŠ¤ì½”í”„ IIFE ë
</script>

